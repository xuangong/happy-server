version: '3.8'

services:
    postgres:
        image: postgres:16-alpine
        container_name: happy-postgres
        environment:
            POSTGRES_USER: ${POSTGRES_USER:-postgres}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
            POSTGRES_DB: ${POSTGRES_DB:-handy}
        volumes:
            - ./data/postgres:/var/lib/postgresql/data
        expose:
            - "5432"
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-handy}"]
            interval: 5s
            timeout: 5s
            retries: 5

    redis:
        image: redis:7-alpine
        container_name: happy-redis
        command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
        volumes:
            - ./data/redis:/data
        expose:
            - "6379"
        healthcheck:
            test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
            interval: 5s
            timeout: 5s
            retries: 5

    minio:
        image: minio/minio
        container_name: happy-minio
        command: server /data --console-address ":9001"
        environment:
            MINIO_ROOT_USER: ${MINIO_ROOT_USER}
            MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
        volumes:
            - ./data/minio:/data
        expose:
            - "9000"
            - "9001"
        healthcheck:
            test: ["CMD", "mc", "ready", "local"]
            interval: 5s
            timeout: 5s
            retries: 5

    # MinIO bucket initialization
    minio-init:
        image: minio/mc
        container_name: happy-minio-init
        depends_on:
            minio:
                condition: service_started
        entrypoint: >
            /bin/sh -c "
            sleep 5;
            mc alias set local http://minio:9000 ${MINIO_ROOT_USER} ${MINIO_ROOT_PASSWORD};
            mc mb -p local/happy || true;
            mc anonymous set download local/happy;
            exit 0;
            "

    happy-server:
        build:
            context: .
            dockerfile: Dockerfile
        container_name: happy-server
        depends_on:
            postgres:
                condition: service_healthy
            redis:
                condition: service_healthy
            minio:
                condition: service_started
            minio-init:
                condition: service_completed_successfully
        environment:
            # Database
            DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-handy}
            # Redis
            REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379
            # S3/MinIO
            S3_HOST: minio
            S3_PORT: "9000"
            S3_USE_SSL: "false"
            S3_ACCESS_KEY: ${MINIO_ROOT_USER}
            S3_SECRET_KEY: ${MINIO_ROOT_PASSWORD}
            S3_BUCKET: happy
            S3_PUBLIC_URL: ${S3_PUBLIC_URL:-http://localhost:9000/happy}
            # Server
            PORT: "3005"
            NODE_ENV: production
            HANDY_MASTER_SECRET: ${HANDY_MASTER_SECRET}
            # Metrics
            METRICS_ENABLED: "true"
            METRICS_PORT: "9090"
            # Optional: GitHub OAuth (required for login)
            # GITHUB_APP_ID: ""
            # GITHUB_PRIVATE_KEY: ""
            # GITHUB_CLIENT_ID: ""
            # GITHUB_CLIENT_SECRET: ""
            # GITHUB_REDIRECT_URI: ""
            # GITHUB_WEBHOOK_SECRET: ""
            # Optional: Voice feature
            # ELEVENLABS_API_KEY: ""
        expose:
            - "3005"
        ports:
            - "9090:9090"  # Metrics
        healthcheck:
            test: ["CMD", "wget", "-q", "--spider", "http://localhost:3005/health"]
            interval: 10s
            timeout: 5s
            retries: 3
            start_period: 30s

    happy-webapp:
        build:
            context: ../happy
            dockerfile: Dockerfile.webapp
            args:
                EXPO_PUBLIC_HAPPY_SERVER_URL: https://xianliao.de5.net:8443
        container_name: happy-webapp
        ports:
            - "8888:80"
        depends_on:
            - happy-server
        restart: always

    caddy:
        image: slothcroissant/caddy-cloudflaredns:latest
        container_name: happy-caddy
        restart: always
        ports:
            - "${LISTEN_PORT:-8443}:${LISTEN_PORT:-8443}"
        environment:
            CLOUDFLARE_API_TOKEN: ${CLOUDFLARE_API_TOKEN}
        volumes:
            - ./Caddyfile:/etc/caddy/Caddyfile:ro
            - ./data/caddy:/data
            - ./data/caddy_config:/config
        depends_on:
            - happy-server

volumes:
    postgres_data:
    redis_data:
    minio_data:
